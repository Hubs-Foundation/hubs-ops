name: turkey gitops reusable workflow

on:
  workflow_call:
    inputs:
      promoteFrom:
        required: true
        type: string
      promoteTo:
        required: true
        type: string
jobs:
  promote:
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/prod'
    runs-on: ubuntu-latest
    steps:
      - name: promote artifact
        run: |
          echo ${{ secrets.DOCKER_HUB_PWD }} | sudo docker login --username $registryName --password-stdin
          docker pull ${{ inputs.promoteFrom }}
          docker tag ${{ inputs.promoteFrom }} ${{ inputs.promoteTo }}
          sudo docker push ${{ inputs.promoteTo }}
          echo "promoted :${{ inputs.promoteFrom }} to :${{ inputs.promoteTo }}"

  staging_pr_to_prod:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    needs: promote
    steps:
      - name: create pr for staging -> prod
        run: |
          gh pr create -H staging -B prod

  prod_cut_release_branch:
    if: github.ref == 'refs/heads/prod'
    runs-on: ubuntu-latest
    needs: promote
    steps:
      - name: cut release branch for prod
        run: |
          git checkout -b releases/$(date '+%y%m%d').$GITHUB_RUN_NUMBER
          